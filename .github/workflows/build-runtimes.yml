name: build-runtimes

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Runtime tag to publish"
        required: false
        default: "latest"
      target_prefix:
        description: "Target runtime registry prefix"
        required: false
        default: "ghcr.io/vizvasanlya/unikctl"
      runtimes:
        description: "Comma-separated runtimes to build"
        required: false
        default: "base,nodejs,python,java,dotnet"
      arch:
        description: "Runtime build architecture"
        required: false
        default: "x86_64"
      plat:
        description: "Runtime build platform"
        required: false
        default: "qemu"
      source_ref:
        description: "Default source git ref"
        required: false
        default: "main"
      source_repo_template:
        description: "Runtime source repository template. Use %s per-runtime, or single monorepo URL."
        required: false
        default: "."
      base_repo:
        description: "Override source repository for base runtime"
        required: false
        default: ""
      nodejs_repo:
        description: "Override source repository for nodejs runtime"
        required: false
        default: ""
      python_repo:
        description: "Override source repository for python runtime"
        required: false
        default: ""
      java_repo:
        description: "Override source repository for java runtime"
        required: false
        default: ""
      dotnet_repo:
        description: "Override source repository for dotnet runtime"
        required: false
        default: ""
      base_subdir:
        description: "Runtime source subdirectory for base (monorepo mode)"
        required: false
        default: "runtimes/base"
      nodejs_subdir:
        description: "Runtime source subdirectory for nodejs (monorepo mode)"
        required: false
        default: "runtimes/nodejs"
      python_subdir:
        description: "Runtime source subdirectory for python (monorepo mode)"
        required: false
        default: "runtimes/python"
      java_subdir:
        description: "Runtime source subdirectory for java (monorepo mode)"
        required: false
        default: "runtimes/java"
      dotnet_subdir:
        description: "Runtime source subdirectory for dotnet (monorepo mode)"
        required: false
        default: "runtimes/dotnet"
      update_lockfile:
        description: "Commit updated runtime lockfile back to branch"
        required: false
        default: "false"
      apply_banner_patch:
        description: "Patch runtime source branding before build"
        required: false
        default: "true"
      banner_patch_file:
        description: "Optional path to custom git patch file for runtime branding"
        required: false
        default: ""

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Configure GHCR auth (no Docker daemon)
        env:
          REGISTRY_USER: ${{ github.actor }}
          REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p "$HOME/.docker"
          auth="$(printf "%s:%s" "$REGISTRY_USER" "$REGISTRY_TOKEN" | base64 | tr -d '\n')"
          cat > "$HOME/.docker/config.json" <<EOF
          {
            "auths": {
              "ghcr.io": {
                "auth": "$auth"
              }
            }
          }
          EOF

      - name: Build and push runtimes from source
        env:
          TARGET_PREFIX: ${{ inputs.target_prefix }}
          TAG: ${{ inputs.tag }}
          RUNTIMES: ${{ inputs.runtimes }}
          ARCH: ${{ inputs.arch }}
          PLAT: ${{ inputs.plat }}
          SOURCE_REF: ${{ inputs.source_ref }}
          SOURCE_REPO_TEMPLATE: ${{ inputs.source_repo_template }}
          APPLY_BANNER_PATCH: ${{ inputs.apply_banner_patch }}
          BANNER_PATCH_FILE: ${{ inputs.banner_patch_file }}
          RUNTIME_BASE_REPO: ${{ inputs.base_repo }}
          RUNTIME_NODEJS_REPO: ${{ inputs.nodejs_repo }}
          RUNTIME_PYTHON_REPO: ${{ inputs.python_repo }}
          RUNTIME_JAVA_REPO: ${{ inputs.java_repo }}
          RUNTIME_DOTNET_REPO: ${{ inputs.dotnet_repo }}
          RUNTIME_BASE_SUBDIR: ${{ inputs.base_subdir }}
          RUNTIME_NODEJS_SUBDIR: ${{ inputs.nodejs_subdir }}
          RUNTIME_PYTHON_SUBDIR: ${{ inputs.python_subdir }}
          RUNTIME_JAVA_SUBDIR: ${{ inputs.java_subdir }}
          RUNTIME_DOTNET_SUBDIR: ${{ inputs.dotnet_subdir }}
          RUNTIME_REPO_TOKEN: ${{ secrets.RUNTIME_REPO_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/build-runtimes-from-source.sh scripts/patch-runtime-banner.sh
          export GIT_AUTH_TOKEN="${RUNTIME_REPO_TOKEN:-$GITHUB_TOKEN}"
          ./scripts/build-runtimes-from-source.sh

      - name: Generate runtime lock file
        env:
          TARGET_PREFIX: ${{ inputs.target_prefix }}
          TAG: ${{ inputs.tag }}
          RUNTIMES: ${{ inputs.runtimes }}
          REQUIRED_RUNTIMES: ${{ inputs.runtimes }}
          REQUIRE_DIGESTS: "true"
          OUTPUT: internal/runtimeutil/runtime-lock.json
        run: |
          chmod +x scripts/generate-runtime-lock.sh
          ./scripts/generate-runtime-lock.sh
          cat internal/runtimeutil/runtime-lock.json

      - name: Upload runtime lock file
        uses: actions/upload-artifact@v6
        with:
          name: runtime-lock
          path: internal/runtimeutil/runtime-lock.json

      - name: Commit runtime lock file
        if: ${{ inputs.update_lockfile == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add internal/runtimeutil/runtime-lock.json
          git commit -m "Update runtime lockfile for ${{ inputs.tag }}" || exit 0
          git push
