name: build-runtimes

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Runtime tag to publish"
        required: false
        default: "latest"
      target_prefix:
        description: "Target runtime registry prefix"
        required: false
        default: "ghcr.io/vizvasanlya/unikctl"
      runtimes:
        description: "Comma-separated runtimes to build"
        required: false
        default: "base,nodejs,python,java,dotnet"
      arch:
        description: "Runtime build architecture"
        required: false
        default: "x86_64"
      plat:
        description: "Runtime build platform"
        required: false
        default: "qemu"
      source_ref:
        description: "Default source git ref"
        required: false
        default: "main"
      source_repo_template:
        description: "Default source repository template (use %s for runtime name)"
        required: false
        default: "https://github.com/vizvasanlya/unikctl-runtime-%s.git"
      base_repo:
        description: "Override source repository for base runtime"
        required: false
        default: ""
      nodejs_repo:
        description: "Override source repository for nodejs runtime"
        required: false
        default: ""
      python_repo:
        description: "Override source repository for python runtime"
        required: false
        default: ""
      java_repo:
        description: "Override source repository for java runtime"
        required: false
        default: ""
      dotnet_repo:
        description: "Override source repository for dotnet runtime"
        required: false
        default: ""
      update_lockfile:
        description: "Commit updated runtime lockfile back to branch"
        required: false
        default: "false"
      apply_banner_patch:
        description: "Patch runtime source branding before build"
        required: false
        default: "true"
      banner_patch_file:
        description: "Optional path to custom git patch file for runtime branding"
        required: false
        default: ""

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push runtimes from source
        env:
          TARGET_PREFIX: ${{ inputs.target_prefix }}
          TAG: ${{ inputs.tag }}
          RUNTIMES: ${{ inputs.runtimes }}
          ARCH: ${{ inputs.arch }}
          PLAT: ${{ inputs.plat }}
          SOURCE_REF: ${{ inputs.source_ref }}
          SOURCE_REPO_TEMPLATE: ${{ inputs.source_repo_template }}
          APPLY_BANNER_PATCH: ${{ inputs.apply_banner_patch }}
          BANNER_PATCH_FILE: ${{ inputs.banner_patch_file }}
          RUNTIME_BASE_REPO: ${{ inputs.base_repo }}
          RUNTIME_NODEJS_REPO: ${{ inputs.nodejs_repo }}
          RUNTIME_PYTHON_REPO: ${{ inputs.python_repo }}
          RUNTIME_JAVA_REPO: ${{ inputs.java_repo }}
          RUNTIME_DOTNET_REPO: ${{ inputs.dotnet_repo }}
          RUNTIME_REPO_TOKEN: ${{ secrets.RUNTIME_REPO_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/build-runtimes-from-source.sh scripts/patch-runtime-banner.sh
          export GIT_AUTH_TOKEN="${RUNTIME_REPO_TOKEN:-$GITHUB_TOKEN}"
          ./scripts/build-runtimes-from-source.sh

      - name: Generate runtime lock file
        env:
          TARGET_PREFIX: ${{ inputs.target_prefix }}
          TAG: ${{ inputs.tag }}
          RUNTIMES: ${{ inputs.runtimes }}
          OUTPUT: internal/runtimeutil/runtime-lock.json
        run: |
          chmod +x scripts/generate-runtime-lock.sh
          ./scripts/generate-runtime-lock.sh
          cat internal/runtimeutil/runtime-lock.json

      - name: Upload runtime lock file
        uses: actions/upload-artifact@v4
        with:
          name: runtime-lock
          path: internal/runtimeutil/runtime-lock.json

      - name: Commit runtime lock file
        if: ${{ inputs.update_lockfile == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add internal/runtimeutil/runtime-lock.json
          git commit -m "Update runtime lockfile for ${{ inputs.tag }}" || exit 0
          git push
