version: 2
#! .goreleaser.yaml
#@ binaries = {
#@   "unikctl": {
#@     "darwin": ["amd64", "arm64"],
#@     "freebsd": ["amd64", "arm64"],
#@     "linux": ["amd64", "arm64"],
#@     "windows": ["amd64", "arm64"],
#@   },
#@   "runu": {
#@     "linux": ["amd64"],
#@   },
#@ }

before:
  hooks:
    - make man

changelog:
  sort: asc
  use: github
  filters:
    include:
      - '^.*#[[:digit:]]+.*$'
  groups:
    - title: ‚ö†Ô∏è Breaking Changes
      regexp: '^[[:xdigit:]]+: [[:lower:]]+(\(.*\))?!:.*$'
      order: 1
    - title: üöÄ New Features
      regexp: '^[[:xdigit:]]+: feat(\(.*\))?:.*$'
      order: 2
    - title: üêõ Bug Fixes
      regexp: '^[[:xdigit:]]+: fix(\(.*\))?:.*$'
      order: 3
    - title: üìñ Docs
      regexp: '^[[:xdigit:]]+: docs(\(.*\))?:.*$'
      order: 4
    - title: ü§ñ Bumps
      regexp: '^[[:xdigit:]]+: (gomod|build)\(deps\):.*$'
      order: 5
    - title: üêí Miscellaneous
      order: 999

release:
  draft: false
  prerelease: false
  mode: replace
  header: |
    ## unikctl {{ .Tag }} ({{ .Date }})

    This is a stable release of unikctl.
  name_template: 'v{{ .Version }}'
  extra_files:
    - glob: public.key

nfpms:
  - vendor: Unikraft
    id: nfpm-default
    maintainer: Alexander Jung <alex@unikraft.io>
    description: Build and use highly customized and ultra-lightweight unikernels.
    license: BSD 3-clause
    bindir: /usr/bin
    homepage: https://unikctl.sh
    formats:
      - deb
      - rpm
      - apk
    recommends:
      - bison
      - build-essential
      - flex
      - git
      - libncurses-dev
      - qemu-system
      - socat
      - unzip
      - wget
    suggests:
      - gcc-x86-64-linux-gnu
      - g++-x86-64-linux-gnu
    contents:
      - src: scripts/kraftld
        dst: /usr/bin/kraftld
      - src: docs/man/
        dst: /usr/share/man/man1/

builds:
#@ for bin, oses in binaries.items():
#@ for os, archs in oses.items():
#@ for arch in archs:
  - id: #@ "{}-{}-{}".format(bin, os, arch)
    binary: #@ bin
    main: #@ "./cmd/{}".format(bin)
    env:
      - GOMOD=unikctl.sh
    #@ if bin == "unikctl" and not(os == "linux" and arch == "amd64"):
      - CGO_ENABLED=0
    #@ end
    goos:
      - #@ os
    goarch:
      - #@ arch
    ldflags:
      - -s -w
      - -X {{ .Env.GOMOD }}/internal/version.version={{ .Version }}
      - -X {{ .Env.GOMOD }}/internal/version.commit={{ .Commit }}
      - -X {{ .Env.GOMOD }}/internal/version.buildTime={{ .Date }}
      #@ if bin == "unikctl" and os == "linux" and arch == "amd64":
      - -extldflags "
        -static
        -lyajl
        -Wl,--whole-archive
        -llzma
        -lbz2
        -lzstd
        -llzo2
        -lxenguest
        -Wl,--no-whole-archive
        -lxenevtchn
        -lxenlight
        -lxenstore
        -lxenctrl
        -lxenforeignmemory
        -lxenforeignmemory
        -lxencall
        -lxentoolcore
        -lxenhypfs
        -lxendevicemodel
        -lxengnttab
        -lxentoollog
        -lz
        -lnl-route-3
        -lnl-3
        -luuid
        -lutil
        "
      #@ elif os != "windows":
      - -extldflags "-static"
      #@ end
      #@ if bin == "unikctl":
      - -X unikctl.sh/internal/cli/unikctl.sentryDsn={{ index .Env "SENTRY_DSN" }}
      #@ end
    tags:
      - netgo
      - osusergo
#@ end
#@ end
#@ end

archives:
#@ for os, archs in binaries["unikctl"].items():
#@ for arch in archs:
  - id: #@ "archive-unikctl-{}-{}".format(os, arch)
    #@ if os == "windows":
    formats: zip
    #@ else:
    formats: tar.gz
    #@ end
    name_template: unikctl_{{ .Version }}_{{ .Os }}_{{ .Arch }}
    builds:
      - #@ "unikctl-{}-{}".format(os, arch)
    #@ if os != "windows":
    files:
      - src: scripts/kraftld
        strip_parent: true
        info:
          mode: 0755
      - src: "docs/man/*.1.gz"
        dst: man
        info:
          mode: 0644
    #@ end
#@ end
#@ end

#@ for os, archs in binaries["runu"].items():
#@ for arch in archs:
  - id: #@ "archive-runu-{}-{}".format(os, arch)
    formats: tar.gz
    name_template: runu_{{ .Version }}_{{ .Os }}_{{ .Arch }}
    builds:
      - #@ "runu-{}-{}".format(os, arch)
#@ end
#@ end
